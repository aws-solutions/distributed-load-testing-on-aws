"use strict";
// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
// SPDX-License-Identifier: Apache-2.0
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.MetricsHelper = void 0;
const client_cloudwatch_1 = require("@aws-sdk/client-cloudwatch");
const client_sqs_1 = require("@aws-sdk/client-sqs");
const client_cloudwatch_logs_1 = require("@aws-sdk/client-cloudwatch-logs");
const types_1 = require("./types");
const client_helper_1 = require("./client-helper");
const axios_1 = __importDefault(require("axios"));
const METRICS_ENDPOINT = "https://metrics.awssolutionsbuilder.com/generic";
const RETRY_LIMIT = 3;
const { EXECUTION_DAY } = process.env;
class MetricsHelper {
    constructor() {
        this.clientHelper = new client_helper_1.ClientHelper();
    }
    async getMetricsData(event) {
        const metricsDataProps = event["metrics-data-query"];
        const endTime = new Date(event.time);
        const input = {
            MetricDataQueries: metricsDataProps,
            StartTime: new Date(endTime.getTime() - (EXECUTION_DAY === types_1.ExecutionDay.DAILY ? 1 : 7) * 86400 * 1000), // 7 or 1 day(s) previous
            EndTime: endTime,
        };
        return await this.fetchMetricsData(input);
    }
    async fetchMetricsData(input) {
        var _a;
        let command = new client_cloudwatch_1.GetMetricDataCommand(input);
        let response;
        const results = {};
        do {
            response = await this.clientHelper.getCwClient().send(command);
            console.info(response);
            (_a = input.MetricDataQueries) === null || _a === void 0 ? void 0 : _a.forEach((item, index) => {
                var _a, _b, _c, _d, _e;
                const key = `${(_b = (_a = item.MetricStat) === null || _a === void 0 ? void 0 : _a.Metric) === null || _b === void 0 ? void 0 : _b.Namespace}/${(_d = (_c = item.MetricStat) === null || _c === void 0 ? void 0 : _c.Metric) === null || _d === void 0 ? void 0 : _d.MetricName}`;
                const value = ((_e = response.MetricDataResults) === null || _e === void 0 ? void 0 : _e[index].Values) || [];
                results[key] = (results[key] || []).concat(...value);
            });
            command = new client_cloudwatch_1.GetMetricDataCommand({ ...input, NextToken: response.NextToken });
        } while (response.NextToken);
        return results;
    }
    processQueryResults(resolvedQueries, body) {
        const failedQueries = [];
        const metricsData = {};
        resolvedQueries.forEach((data, index) => {
            if (data === undefined) {
                failedQueries.push(body.queryIds[index]);
                return;
            }
            if (data.field && data.value) {
                metricsData[data.field] = parseInt(data.value, 10);
            }
        });
        console.debug("Query data: ", JSON.stringify(metricsData, null, 2));
        if (failedQueries.length > 0) {
            const { retry = 0 } = body;
            if (retry < RETRY_LIMIT) {
                body.retry = retry + 1;
                body.queryIds = failedQueries;
                console.debug(`Retrying query resolver. Retry #${retry + 1}`);
                this.sendSQS(body);
            }
            else {
                console.debug("Retries exceeded. Aborting");
            }
        }
        return metricsData;
    }
    async getQueryDefinitions(queryPrefix) {
        const input = {
            queryDefinitionNamePrefix: queryPrefix,
        };
        const command = new client_cloudwatch_logs_1.DescribeQueryDefinitionsCommand(input);
        const response = await this.clientHelper.getCwLogsClient().send(command);
        if (!response.queryDefinitions) {
            return [];
        }
        return response.queryDefinitions;
    }
    async startQueries(event) {
        const queryDefinitions = await this.getQueryDefinitions(process.env.QUERY_PREFIX);
        const endTime = new Date(event.time);
        const queryIds = await Promise.all(queryDefinitions === null || queryDefinitions === void 0 ? void 0 : queryDefinitions.map((queryDefinition) => this.startQuery(queryDefinition, endTime)));
        return await this.sendSQS({ queryIds, endTime: endTime.getTime() });
    }
    async sendSQS(sqsBody) {
        const command = new client_sqs_1.SendMessageCommand({
            MessageBody: JSON.stringify(sqsBody),
            QueueUrl: process.env.SQS_QUEUE_URL,
        });
        return await this.clientHelper.getSqsClient().send(command);
    }
    async startQuery(queryProp, endTime) {
        const input = {
            startTime: endTime.getTime() - (EXECUTION_DAY === types_1.ExecutionDay.DAILY ? 1 : 7) * 86400 * 1000,
            endTime: endTime.getTime(),
            ...queryProp,
        };
        const command = new client_cloudwatch_logs_1.StartQueryCommand(input);
        const response = await this.clientHelper.getCwLogsClient().send(command);
        if (response.queryId) {
            return response.queryId;
        }
        return "";
    }
    async resolveQuery(queryId) {
        var _a;
        const command = new client_cloudwatch_logs_1.GetQueryResultsCommand({ queryId });
        const response = await this.clientHelper.getCwLogsClient().send(command);
        console.debug(`Query response: ${JSON.stringify(response)}`);
        if (response.status === "Running") {
            console.debug(`Query is still running. QueryID: ${queryId}`);
            return undefined;
        }
        return (((_a = response.results) === null || _a === void 0 ? void 0 : _a[0]) ||
            (() => {
                console.debug(`Query contains no results. QueryID: ${queryId}`);
                return [];
            })());
    }
    async resolveQueries(event) {
        const requestBody = JSON.parse(event.Records[0].body);
        const queryIds = requestBody.queryIds;
        if (Object.keys(queryIds).length <= 0)
            return [];
        return (await Promise.all(queryIds.map((queryId) => this.resolveQuery(queryId)))).flat();
    }
    async sendAnonymousMetric(results, startTime, endTime) {
        const result = {
            Message: "",
        };
        try {
            const { SOLUTION_ID, SOLUTION_VERSION, UUID } = process.env;
            const payload = {
                Solution: SOLUTION_ID,
                Version: SOLUTION_VERSION,
                UUID: UUID,
                TimeStamp: new Date().toISOString().replace("T", " ").replace("Z", ""),
                Data: {
                    DataStartTime: startTime.toISOString().replace("T", " ").replace("Z", ""),
                    DataEndTime: endTime.toISOString().replace("T", " ").replace("Z", ""),
                    ...results,
                },
            };
            result.Data = payload;
            const payloadStr = JSON.stringify(payload);
            const config = {
                headers: {
                    "content-type": "application/json",
                    "content-length": payloadStr.length,
                },
            };
            console.info("Sending anonymous metric", payloadStr);
            await axios_1.default.post(METRICS_ENDPOINT, payloadStr, config);
            result.Message = "Anonymous data was sent successfully.";
        }
        catch (err) {
            console.error("Error sending anonymous metric");
            console.error(err);
            result.Message = "Anonymous data sending failed.";
        }
        return result;
    }
}
exports.MetricsHelper = MetricsHelper;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWV0cmljcy1oZWxwZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJtZXRyaWNzLWhlbHBlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEscUVBQXFFO0FBQ3JFLHNDQUFzQzs7Ozs7O0FBRXRDLGtFQUtvQztBQUNwQyxvREFBbUY7QUFDbkYsNEVBU3lDO0FBQ3pDLG1DQUFtSDtBQUduSCxtREFBK0M7QUFDL0Msa0RBQXFEO0FBRXJELE1BQU0sZ0JBQWdCLEdBQUcsaURBQWlELENBQUM7QUFDM0UsTUFBTSxXQUFXLEdBQUcsQ0FBQyxDQUFDO0FBQ3RCLE1BQU0sRUFBRSxhQUFhLEVBQUUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDO0FBRXRDLE1BQWEsYUFBYTtJQUd4QjtRQUNFLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSw0QkFBWSxFQUFFLENBQUM7SUFDekMsQ0FBQztJQUVELEtBQUssQ0FBQyxjQUFjLENBQUMsS0FBNEI7UUFDL0MsTUFBTSxnQkFBZ0IsR0FBc0IsS0FBSyxDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFDeEUsTUFBTSxPQUFPLEdBQUcsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3JDLE1BQU0sS0FBSyxHQUE4QjtZQUN2QyxpQkFBaUIsRUFBRSxnQkFBZ0I7WUFDbkMsU0FBUyxFQUFFLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLGFBQWEsS0FBSyxvQkFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxLQUFLLEdBQUcsSUFBSSxDQUFDLEVBQUUseUJBQXlCO1lBQ2pJLE9BQU8sRUFBRSxPQUFPO1NBQ2pCLENBQUM7UUFDRixPQUFPLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQzVDLENBQUM7SUFFTyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsS0FB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QztRQUMzRCxDQUFDO1FBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztZQUNiLE9BQU8sQ0FBQyxLQUFLLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztZQUNoRCxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBRW5CLE1BQU0sQ0FBQyxPQUFPLEdBQUcsZ0NBQWdDLENBQUM7UUFDcEQsQ0FBQztRQUVELE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7Q0FDRjtBQXRMRCxzQ0FzTEMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbi8vIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wXG5cbmltcG9ydCB7XG4gIEdldE1ldHJpY0RhdGFDb21tYW5kLFxuICBHZXRNZXRyaWNEYXRhQ29tbWFuZElucHV0LFxuICBHZXRNZXRyaWNEYXRhQ29tbWFuZE91dHB1dCxcbiAgTWV0cmljRGF0YVF1ZXJ5LFxufSBmcm9tIFwiQGF3cy1zZGsvY2xpZW50LWNsb3Vkd2F0Y2hcIjtcbmltcG9ydCB7IFNlbmRNZXNzYWdlQ29tbWFuZCwgU2VuZE1lc3NhZ2VDb21tYW5kT3V0cHV0IH0gZnJvbSBcIkBhd3Mtc2RrL2NsaWVudC1zcXNcIjtcbmltcG9ydCB7XG4gIERlc2NyaWJlUXVlcnlEZWZpbml0aW9uc0NvbW1hbmQsXG4gIERlc2NyaWJlUXVlcnlEZWZpbml0aW9uc0NvbW1hbmRJbnB1dCxcbiAgR2V0UXVlcnlSZXN1bHRzQ29tbWFuZCxcbiAgR2V0UXVlcnlSZXN1bHRzQ29tbWFuZE91dHB1dCxcbiAgUmVzdWx0RmllbGQsXG4gIFN0YXJ0UXVlcnlDb21tYW5kLFxuICBTdGFydFF1ZXJ5Q29tbWFuZElucHV0LFxuICBRdWVyeURlZmluaXRpb24sXG59IGZyb20gXCJAYXdzLXNkay9jbGllbnQtY2xvdWR3YXRjaC1sb2dzXCI7XG5pbXBvcnQgeyBFdmVudEJyaWRnZVF1ZXJ5RXZlbnQsIE1ldHJpY1BheWxvYWQsIE1ldHJpY0RhdGEsIFF1ZXJ5UHJvcHMsIFNRU0V2ZW50Qm9keSwgRXhlY3V0aW9uRGF5IH0gZnJvbSBcIi4vdHlwZXNcIjtcbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBpbXBvcnQvbm8tdW5yZXNvbHZlZFxuaW1wb3J0IHsgU1FTRXZlbnQgfSBmcm9tIFwiYXdzLWxhbWJkYVwiO1xuaW1wb3J0IHsgQ2xpZW50SGVscGVyIH0gZnJvbSBcIi4vY2xpZW50LWhlbHBlclwiO1xuaW1wb3J0IGF4aW9zLCB7IFJhd0F4aW9zUmVxdWVzdENvbmZpZyB9IGZyb20gXCJheGlvc1wiO1xuXG5jb25zdCBNRVRSSUNTX0VORFBPSU5UID0gXCJodHRwczovL21ldHJpY3MuYXdzc29sdXRpb25zYnVpbGRlci5jb20vZ2VuZXJpY1wiO1xuY29uc3QgUkVUUllfTElNSVQgPSAzO1xuY29uc3QgeyBFWEVDVVRJT05fREFZIH0gPSBwcm9jZXNzLmVudjtcblxuZXhwb3J0IGNsYXNzIE1ldHJpY3NIZWxwZXIge1xuICBwcml2YXRlIGNsaWVudEhlbHBlcjogQ2xpZW50SGVscGVyO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuY2xpZW50SGVscGVyID0gbmV3IENsaWVudEhlbHBlcigpO1xuICB9XG5cbiAgYXN5bmMgZ2V0TWV0cmljc0RhdGEoZXZlbnQ6IEV2ZW50QnJpZGdlUXVlcnlFdmVudCk6IFByb21pc2U8TWV0cmljRGF0YT4ge1xuICAgIGNvbnN0IG1ldHJpY3NEYXRhUHJvcHM6IE1ldHJpY0RhdGFRdWVyeVtdID0gZXZlbnRbXCJtZXRyaWNzLWRhdGEtcXVlcnlcIl07XG4gICAgY29uc3QgZW5kVGltZSA9IG5ldyBEYXRlKGV2ZW50LnRpbWUpO1xuICAgIGNvbnN0IGlucHV0OiBHZXRNZXRyaWNEYXRhQ29tbWFuZElucHV0ID0ge1xuICAgICAgTWV0cmljRGF0YVF1ZXJpZXM6IG1ldHJpY3NEYXRhUHJvcHMsXG4gICAgICBTdGFydFRpbWU6IG5ldyBEYXRlKGVuZFRpbWUuZ2V0VGltZSgpIC0gKEVYRUNVVElPTl9EQVkgPT09IEV4ZWN1dGlvbkRheS5EQUlMWSA/IDEgOiA3KSAqIDg2NDAwICogMTAwMCksIC8vIDcgb3IgMSBkYXkocykgcHJldmlvdXNcbiAgICAgIEVuZFRpbWU6IGVuZFRpbWUsXG4gICAgfTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5mZXRjaE1ldHJpY3NEYXRhKGlucHV0KTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZmV0Y2hNZXRyaWNzRGF0YShpbnB1dDogR2V0TWV0cmljRGF0YUNvbW1hbmRJbnB1dCk6IFByb21pc2U8TWV0cmljRGF0YT4ge1xuICAgIGxldCBjb21tYW5kID0gbmV3IEdldE1ldHJpY0RhdGFDb21tYW5kKGlucHV0KTtcbiAgICBsZXQgcmVzcG9uc2U6IEdldE1ldHJpY0RhdGFDb21tYW5kT3V0cHV0O1xuICAgIGNvbnN0IHJlc3VsdHM6IE1ldHJpY0RhdGEgPSB7fTtcbiAgICBkbyB7XG4gICAgICByZXNwb25zZSA9IGF3YWl0IHRoaXMuY2xpZW50SGVscGVyLmdldEN3Q2xpZW50KCkuc2VuZChjb21tYW5kKTtcbiAgICAgIGNvbnNvbGUuaW5mbyhyZXNwb25zZSk7XG5cbiAgICAgIGlucHV0Lk1ldHJpY0RhdGFRdWVyaWVzPy5mb3JFYWNoKChpdGVtLCBpbmRleCkgPT4ge1xuICAgICAgICBjb25zdCBrZXkgPSBgJHtpdGVtLk1ldHJpY1N0YXQ/Lk1ldHJpYz8uTmFtZXNwYWNlfS8ke2l0ZW0uTWV0cmljU3RhdD8uTWV0cmljPy5NZXRyaWNOYW1lfWA7XG4gICAgICAgIGNvbnN0IHZhbHVlOiBudW1iZXJbXSA9IHJlc3BvbnNlLk1ldHJpY0RhdGFSZXN1bHRzPy5baW5kZXhdLlZhbHVlcyB8fCBbXTtcbiAgICAgICAgcmVzdWx0c1trZXldID0gKChyZXN1bHRzW2tleV0gYXMgbnVtYmVyW10pIHx8IFtdKS5jb25jYXQoLi4udmFsdWUpO1xuICAgICAgfSk7XG5cbiAgICAgIGNvbW1hbmQgPSBuZXcgR2V0TWV0cmljRGF0YUNvbW1hbmQoeyAuLi5pbnB1dCwgTmV4dFRva2VuOiByZXNwb25zZS5OZXh0VG9rZW4gfSk7XG4gICAgfSB3aGlsZSAocmVzcG9uc2UuTmV4dFRva2VuKTtcblxuICAgIHJldHVybiByZXN1bHRzO1xuICB9XG5cbiAgcHJvY2Vzc1F1ZXJ5UmVzdWx0cyhyZXNvbHZlZFF1ZXJpZXM6IChSZXN1bHRGaWVsZCB8IHVuZGVmaW5lZClbXSwgYm9keTogU1FTRXZlbnRCb2R5KTogTWV0cmljRGF0YSB7XG4gICAgY29uc3QgZmFpbGVkUXVlcmllczogc3RyaW5nW10gPSBbXTtcbiAgICBjb25zdCBtZXRyaWNzRGF0YTogTWV0cmljRGF0YSA9IHt9O1xuICAgIHJlc29sdmVkUXVlcmllcy5mb3JFYWNoKChkYXRhLCBpbmRleCkgPT4ge1xuICAgICAgaWYgKGRhdGEgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBmYWlsZWRRdWVyaWVzLnB1c2goYm9keS5xdWVyeUlkc1tpbmRleF0pO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBpZiAoZGF0YS5maWVsZCAmJiBkYXRhLnZhbHVlKSB7XG4gICAgICAgIG1ldHJpY3NEYXRhW2RhdGEuZmllbGQhXSA9IHBhcnNlSW50KGRhdGEudmFsdWUhLCAxMCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgY29uc29sZS5kZWJ1ZyhcIlF1ZXJ5IGRhdGE6IFwiLCBKU09OLnN0cmluZ2lmeShtZXRyaWNzRGF0YSwgbnVsbCwgMikpO1xuXG4gICAgaWYgKGZhaWxlZFF1ZXJpZXMubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgeyByZXRyeSA9IDAgfSA9IGJvZHk7XG4gICAgICBpZiAocmV0cnkgPCBSRVRSWV9MSU1JVCkge1xuICAgICAgICBib2R5LnJldHJ5ID0gcmV0cnkgKyAxO1xuICAgICAgICBib2R5LnF1ZXJ5SWRzID0gZmFpbGVkUXVlcmllcztcbiAgICAgICAgY29uc29sZS5kZWJ1ZyhgUmV0cnlpbmcgcXVlcnkgcmVzb2x2ZXIuIFJldHJ5ICMke3JldHJ5ICsgMX1gKTtcbiAgICAgICAgdGhpcy5zZW5kU1FTKGJvZHkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS5kZWJ1ZyhcIlJldHJpZXMgZXhjZWVkZWQuIEFib3J0aW5nXCIpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbWV0cmljc0RhdGE7XG4gIH1cblxuICBhc3luYyBnZXRRdWVyeURlZmluaXRpb25zKHF1ZXJ5UHJlZml4OiBzdHJpbmcpOiBQcm9taXNlPFF1ZXJ5RGVmaW5pdGlvbltdPiB7XG4gICAgY29uc3QgaW5wdXQ6IERlc2NyaWJlUXVlcnlEZWZpbml0aW9uc0NvbW1hbmRJbnB1dCA9IHtcbiAgICAgIHF1ZXJ5RGVmaW5pdGlvbk5hbWVQcmVmaXg6IHF1ZXJ5UHJlZml4LFxuICAgIH07XG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBEZXNjcmliZVF1ZXJ5RGVmaW5pdGlvbnNDb21tYW5kKGlucHV0KTtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuY2xpZW50SGVscGVyLmdldEN3TG9nc0NsaWVudCgpLnNlbmQoY29tbWFuZCk7XG5cbiAgICBpZiAoIXJlc3BvbnNlLnF1ZXJ5RGVmaW5pdGlvbnMpIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3BvbnNlLnF1ZXJ5RGVmaW5pdGlvbnM7XG4gIH1cblxuICBhc3luYyBzdGFydFF1ZXJpZXMoZXZlbnQ6IEV2ZW50QnJpZGdlUXVlcnlFdmVudCk6IFByb21pc2U8U2VuZE1lc3NhZ2VDb21tYW5kT3V0cHV0PiB7XG4gICAgY29uc3QgcXVlcnlEZWZpbml0aW9ucyA9IGF3YWl0IHRoaXMuZ2V0UXVlcnlEZWZpbml0aW9ucyhwcm9jZXNzLmVudi5RVUVSWV9QUkVGSVggYXMgc3RyaW5nKTtcbiAgICBjb25zdCBlbmRUaW1lID0gbmV3IERhdGUoZXZlbnQudGltZSk7XG4gICAgY29uc3QgcXVlcnlJZHMgPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgIHF1ZXJ5RGVmaW5pdGlvbnM/Lm1hcCgocXVlcnlEZWZpbml0aW9uKSA9PiB0aGlzLnN0YXJ0UXVlcnkocXVlcnlEZWZpbml0aW9uIGFzIFF1ZXJ5UHJvcHMsIGVuZFRpbWUpKVxuICAgICk7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuc2VuZFNRUyh7IHF1ZXJ5SWRzLCBlbmRUaW1lOiBlbmRUaW1lLmdldFRpbWUoKSB9KTtcbiAgfVxuXG4gIGFzeW5jIHNlbmRTUVMoc3FzQm9keTogU1FTRXZlbnRCb2R5KTogUHJvbWlzZTxTZW5kTWVzc2FnZUNvbW1hbmRPdXRwdXQ+IHtcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IFNlbmRNZXNzYWdlQ29tbWFuZCh7XG4gICAgICBNZXNzYWdlQm9keTogSlNPTi5zdHJpbmdpZnkoc3FzQm9keSksXG4gICAgICBRdWV1ZVVybDogcHJvY2Vzcy5lbnYuU1FTX1FVRVVFX1VSTCxcbiAgICB9KTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5jbGllbnRIZWxwZXIuZ2V0U3FzQ2xpZW50KCkuc2VuZChjb21tYW5kKTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0UXVlcnkocXVlcnlQcm9wOiBRdWVyeVByb3BzLCBlbmRUaW1lOiBEYXRlKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCBpbnB1dDogU3RhcnRRdWVyeUNvbW1hbmRJbnB1dCA9IHtcbiAgICAgIHN0YXJ0VGltZTogZW5kVGltZS5nZXRUaW1lKCkgLSAoRVhFQ1VUSU9OX0RBWSA9PT0gRXhlY3V0aW9uRGF5LkRBSUxZID8gMSA6IDcpICogODY0MDAgKiAxMDAwLFxuICAgICAgZW5kVGltZTogZW5kVGltZS5nZXRUaW1lKCksXG4gICAgICAuLi5xdWVyeVByb3AsXG4gICAgfTtcblxuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgU3RhcnRRdWVyeUNvbW1hbmQoaW5wdXQpO1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5jbGllbnRIZWxwZXIuZ2V0Q3dMb2dzQ2xpZW50KCkuc2VuZChjb21tYW5kKTtcbiAgICBpZiAocmVzcG9uc2UucXVlcnlJZCkge1xuICAgICAgcmV0dXJuIHJlc3BvbnNlLnF1ZXJ5SWQ7XG4gICAgfVxuICAgIHJldHVybiBcIlwiO1xuICB9XG5cbiAgYXN5bmMgcmVzb2x2ZVF1ZXJ5KHF1ZXJ5SWQ6IHN0cmluZyk6IFByb21pc2U8UmVzdWx0RmllbGRbXSB8IHVuZGVmaW5lZD4ge1xuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgR2V0UXVlcnlSZXN1bHRzQ29tbWFuZCh7IHF1ZXJ5SWQgfSk7XG4gICAgY29uc3QgcmVzcG9uc2U6IEdldFF1ZXJ5UmVzdWx0c0NvbW1hbmRPdXRwdXQgPSBhd2FpdCB0aGlzLmNsaWVudEhlbHBlci5nZXRDd0xvZ3NDbGllbnQoKS5zZW5kKGNvbW1hbmQpO1xuICAgIGNvbnNvbGUuZGVidWcoYFF1ZXJ5IHJlc3BvbnNlOiAke0pTT04uc3RyaW5naWZ5KHJlc3BvbnNlKX1gKTtcbiAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSBcIlJ1bm5pbmdcIikge1xuICAgICAgY29uc29sZS5kZWJ1ZyhgUXVlcnkgaXMgc3RpbGwgcnVubmluZy4gUXVlcnlJRDogJHtxdWVyeUlkfWApO1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgcmV0dXJuIChcbiAgICAgIHJlc3BvbnNlLnJlc3VsdHM/LlswXSB8fFxuICAgICAgKCgpID0+IHtcbiAgICAgICAgY29uc29sZS5kZWJ1ZyhgUXVlcnkgY29udGFpbnMgbm8gcmVzdWx0cy4gUXVlcnlJRDogJHtxdWVyeUlkfWApO1xuICAgICAgICByZXR1cm4gW107XG4gICAgICB9KSgpXG4gICAgKTtcbiAgfVxuXG4gIGFzeW5jIHJlc29sdmVRdWVyaWVzKGV2ZW50OiBTUVNFdmVudCk6IFByb21pc2U8KFJlc3VsdEZpZWxkIHwgdW5kZWZpbmVkKVtdPiB7XG4gICAgY29uc3QgcmVxdWVzdEJvZHkgPSBKU09OLnBhcnNlKGV2ZW50LlJlY29yZHNbMF0uYm9keSk7XG4gICAgY29uc3QgcXVlcnlJZHMgPSByZXF1ZXN0Qm9keS5xdWVyeUlkcztcbiAgICBpZiAoT2JqZWN0LmtleXMocXVlcnlJZHMpLmxlbmd0aCA8PSAwKSByZXR1cm4gW107XG4gICAgcmV0dXJuIChhd2FpdCBQcm9taXNlLmFsbChxdWVyeUlkcy5tYXAoKHF1ZXJ5SWQ6IHN0cmluZykgPT4gdGhpcy5yZXNvbHZlUXVlcnkocXVlcnlJZCkpKSkuZmxhdCgpO1xuICB9XG5cbiAgYXN5bmMgc2VuZEFub255bW91c01ldHJpYyhcbiAgICByZXN1bHRzOiBNZXRyaWNEYXRhLFxuICAgIHN0YXJ0VGltZTogRGF0ZSxcbiAgICBlbmRUaW1lOiBEYXRlXG4gICk6IFByb21pc2U8eyBNZXNzYWdlOiBzdHJpbmc7IERhdGE/OiBNZXRyaWNQYXlsb2FkIH0+IHtcbiAgICBjb25zdCByZXN1bHQ6IHsgTWVzc2FnZTogc3RyaW5nOyBEYXRhPzogTWV0cmljUGF5bG9hZCB9ID0ge1xuICAgICAgTWVzc2FnZTogXCJcIixcbiAgICB9O1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgU09MVVRJT05fSUQsIFNPTFVUSU9OX1ZFUlNJT04sIFVVSUQgfSA9IHByb2Nlc3MuZW52O1xuICAgICAgY29uc3QgcGF5bG9hZDogTWV0cmljUGF5bG9hZCA9IHtcbiAgICAgICAgU29sdXRpb246IFNPTFVUSU9OX0lEIGFzIHN0cmluZyxcbiAgICAgICAgVmVyc2lvbjogU09MVVRJT05fVkVSU0lPTiBhcyBzdHJpbmcsXG4gICAgICAgIFVVSUQ6IFVVSUQgYXMgc3RyaW5nLFxuICAgICAgICBUaW1lU3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5yZXBsYWNlKFwiVFwiLCBcIiBcIikucmVwbGFjZShcIlpcIiwgXCJcIiksXG4gICAgICAgIERhdGE6IHtcbiAgICAgICAgICBEYXRhU3RhcnRUaW1lOiBzdGFydFRpbWUudG9JU09TdHJpbmcoKS5yZXBsYWNlKFwiVFwiLCBcIiBcIikucmVwbGFjZShcIlpcIiwgXCJcIiksXG4gICAgICAgICAgRGF0YUVuZFRpbWU6IGVuZFRpbWUudG9JU09TdHJpbmcoKS5yZXBsYWNlKFwiVFwiLCBcIiBcIikucmVwbGFjZShcIlpcIiwgXCJcIiksXG4gICAgICAgICAgLi4ucmVzdWx0cyxcbiAgICAgICAgfSxcbiAgICAgIH07XG5cbiAgICAgIHJlc3VsdC5EYXRhID0gcGF5bG9hZDtcblxuICAgICAgY29uc3QgcGF5bG9hZFN0ciA9IEpTT04uc3RyaW5naWZ5KHBheWxvYWQpO1xuXG4gICAgICBjb25zdCBjb25maWc6IFJhd0F4aW9zUmVxdWVzdENvbmZpZyA9IHtcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgIFwiY29udGVudC10eXBlXCI6IFwiYXBwbGljYXRpb24vanNvblwiLFxuICAgICAgICAgIFwiY29udGVudC1sZW5ndGhcIjogcGF5bG9hZFN0ci5sZW5ndGgsXG4gICAgICAgIH0sXG4gICAgICB9O1xuXG4gICAgICBjb25zb2xlLmluZm8oXCJTZW5kaW5nIGFub255bW91cyBtZXRyaWNcIiwgcGF5bG9hZFN0cik7XG4gICAgICBhd2FpdCBheGlvcy5wb3N0KE1FVFJJQ1NfRU5EUE9JTlQsIHBheWxvYWRTdHIsIGNvbmZpZyk7XG5cbiAgICAgIHJlc3VsdC5NZXNzYWdlID0gXCJBbm9ueW1vdXMgZGF0YSB3YXMgc2VudCBzdWNjZXNzZnVsbHkuXCI7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwiRXJyb3Igc2VuZGluZyBhbm9ueW1vdXMgbWV0cmljXCIpO1xuICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuXG4gICAgICByZXN1bHQuTWVzc2FnZSA9IFwiQW5vbnltb3VzIGRhdGEgc2VuZGluZyBmYWlsZWQuXCI7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxufVxuIl19